#!/usr/bin/env bash
test -f "./.recipes.txt" || (echo "Please run from recipes root directory"; exit 1) || exit 1


paths=()
titles=()


markdown() {
    ./lib/markdown.pl "$@"
}
template() {
    local templatePath="$1"
    local title="$2"
    local content="$3"
    local dst="$4"
    local template="$(cat "${templatePath}")"
    echo "${content}" > "${dst}.tmp"
    echo "${template}" \
        | sed -r \
            -e "s=\{\{ title \}\}=${title}=" \
            -e "/\{\{ content \}\}/r ${dst}.tmp" \
            -e "/\{\{ content \}\}/d" \
        > "${dst}"
    rm "${dst}.tmp"
}
process_file() {
    local src=$1
    local dst=$(echo "$src" | sed -re 's|src/|var/|; s/\.markdown$/.html/')

    local content=$(markdown "${src}")
    local title=$(echo "${content}" | grep '<h1>' -m1 | sed -re 's|<h1>(.+)</h1>|\1|')

    paths=("${paths[@]}" "$dst")
    titles=("${titles[@]}" "$title")

    template "./etc/recipe.html" "${title}" "${content}" "${dst}"
}

make_recipes() {
    for f in ./src/*.markdown; do
        process_file "${f}"
    done
}
make_index() {
    local src=./src/index.markdown
    local dst=./var/index.html

    local len=${#titles[@]}
    for (( i = 0; i < len; i++ )); do
        local path=${paths[$i]/.\/var\//}
        local title=${titles[$i]}
        local item="* [${title}](${path})"
        echo "${item}" >> "${src}"
    done
    local content=$(markdown "${src}")
    template "./etc/index.html" "" "${content}" "${dst}"
}

clean() {
    rm -f ./src/index.markdown
    rm -f ./var/*.html
}
build() {
    make_recipes
    make_index
}


case $1 in
    clean)
        clean
        ;;
    *)
        clean
        build
        ;;
esac
